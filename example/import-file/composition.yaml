apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: function-pkl
spec:
  compositeTypeRef:
    apiVersion: example.crossplane.io/v1
    kind: XR
  mode: Pipeline
  pipeline:
  - step: run-the-template
    functionRef:
      name: function-pkl
    input:
      apiVersion: template.fn.crossplane.io/v1beta1
      kind: Pkl
      spec:
        files:
          foo.pkl: |
            amends "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.0.1#/api/core/v1/ConfigMap.pkl"

            metadata {
                name = "foo"
            }

            data {
                ["foo"] = "bar"
            }
          bar.pkl: |
            amends "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.0.1#/api/core/v1/ConfigMap.pkl"

            local foo = import("crossplane:/observed/resources/foo/resource")

            metadata {
                name = "bar"
            }

            data {
                ["bar"] = foo.resources[0].data["foo"]
            }
