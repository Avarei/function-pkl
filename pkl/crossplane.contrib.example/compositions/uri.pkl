amends "@crossplane.contrib/Composition.pkl"
import "@crossplane.contrib/Pkl.pkl"

import "../crds/XR.pkl"
import "steps/full.pkl"

import "pkl:reflect"

metadata {
  name = "pkl-uri-example"
}
spec {
  compositeTypeRef {
    apiVersion = XR.apiVersion
    kind = XR.kind
  }
  mode = "Pipeline"
  pipeline {
    new {
      step = "pkl-template"
      functionRef {
        name = "function-pkl"
      }
      input = new Pkl {
        spec {
          type = "uri"
          uri =
            let (uri = reflect.Module(full).uri)
            if (uri.startsWith("file:")) // This assumes that PklProject is present when run locally. It is not available in the package
              let (pkg = import("../PklProject").package)
              pkg.baseUri + "@" + pkg.version + "#/compositions/steps/full.pkl"
            else
              uri
        }
      }
    }
  }
}
