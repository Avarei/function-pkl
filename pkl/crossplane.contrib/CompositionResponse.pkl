@ModuleInfo { minPklVersion = "0.25.1" }
module CompositionResponse

import "RunFunction.pkl"
import "Resource.pkl"

/// Metadata pertaining to this response.
meta: ResponseMeta?

/// ResponseMeta contains metadata pertaining to a RunFunctionResponse.
class ResponseMeta {
  /// Time-to-live of this response. Deterministic Functions with no side-effects
  /// (e.g. simple templating Functions) may specify a TTL. Crossplane may choose
  /// to cache responses until the TTL expires.
  ttl: Duration
}

/// Desired state according to a Function pipeline. Functions may add desired
/// state, and may mutate or delete any part of the desired state they are
/// concerned with. A Function must pass through any part of the desired state
/// that it is not concerned with.
///
/// Note that the desired state must be a partial object with only the fields
/// that this function (and its predecessors in the pipeline) wants to have
/// set in the object. Copying a non-partial observed state to desired is most
/// likely not what you want to do. Leaving out fields that had been returned
/// as desired before will result in them being deleted from the objects in the
/// cluster.
desired: Resource.DesiredState?

/// Results of the Function run. Results are used for observability purposes.
results: List<Result>?

/// A Result of running a Function.
class Result {
  /// Severity of this result.
  severity: Severity = "Unspecified"
  /// Human-readable details about the result.
  message: String
}
typealias Severity = "Normal"|"Warning"|"Fatal"|"Unspecified"

/// Optional context to be passed to the next Function in the pipeline as part
/// of the RunFunctionRequest. Dropped on the last function in the pipeline.
context: Mapping<String, Any>?

/// Requirements that must be satisfied for this Function to run successfully.
requirements: Requirements?

class Requirements {
  extraResources: Mapping<String, ResourceSelector?>
}

/// ResourceSelector selects a group of resources, either by name or by label.
class ResourceSelector {
  apiVersion: String
  kind: String
  match: Match
}

class Match {
  /// Match the resource with this name.
  /// Note: matchLabels takes precedence if both are defined.
  matchName: String?
  /// Match all resources with these labels.
  matchLabels: MatchLabels?
}

/// MatchLabels defines a set of labels to match resources against.
class MatchLabels {
  labels: Mapping<String, String>
}

output {
  renderer = new YamlRenderer {
    converters {
      [DataSize] = (size: DataSize) ->
          let (unit = size.unit)
            let (k8sUnit =
              if (unit.length == 3) unit[0].toUpperCase() + unit[1]
              else if (unit.length == 2) unit[0].toUpperCase()
              else "")
              "\(size.value)\(k8sUnit)"
      [Duration] = (duration: Duration) ->
          let (secs = duration.toUnit("s").value.toInt())
            let (ns: Duration = duration - secs.s)
              new protobufDuration {
                seconds = secs
                nanos = ns.toUnit("ns").value.toInt()
              }
      [Resource.DesiredComposed] = (dc: Resource.DesiredComposed) ->
          if (dc.ready == "True")
            new RunFunction.Resource {
              resource = dc.resource
              ready = READY_TRUE
            }
          else if (dc.ready == "False")
            new RunFunction.Resource {
              resource = dc.resource
              ready = READY_FALSE
            }
          else
            new RunFunction.Resource {
              resource = dc.resource
              ready = READY_UNSPECIFIED
            }
      [Result] = (res: Result) ->
          if (res.severity == "Normal")
            new RunFunction.Result {
              message = res.message
              severity = SEVERITY_NORMAL
            }
          else if (res.severity == "Warning")
            new RunFunction.Result {
              message = res.message
              severity = SEVERITY_WARNING
            }
          else if (res.severity == "Fatal")
            new RunFunction.Result {
              message = res.message
              severity = SEVERITY_FATAL
            }
          else
            new RunFunction.Result {
              message = res.message
              severity = SEVERITY_UNSPECIFIED
            }
    }
  }
}

local class protobufDuration {
  seconds: Int // int64 not available in pkl
  nanos: Int
}

// Convert to a pretty printed Pcf file
function toPrettyString(): String = new PcfRenderer {
  omitNullProperties = true
}.renderDocument(this)
